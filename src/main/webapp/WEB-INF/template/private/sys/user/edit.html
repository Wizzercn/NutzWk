#sys_top
#sys_head


<section class="layout">
    #sys_menu
    <!-- 列表 -->
    <section class="main-content bg-white">
        <header class="header navbar bg-white shadow">
            <div class="btn-group tool-button">
                <a class="btn btn-primary navbar-btn" href="${base}/private/sys/user"><i class="ti-angle-left"></i> 返回</a>
            </div>
        </header>
        <div class="content-wrap">
            <div class="wrapper">
                <section class="panel">
                    <form id="userAddForm" role="form" class="form-horizontal parsley-form" data-parsley-validate action="${base}/private/sys/user/edit/do" method="post">
                        <input type="hidden" name="u.id" value="$!obj.id"/>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-group has-feedback">
                                    <label for="unitName" class="col-sm-2 control-label">所属机构</label>
                                    <div class="col-sm-8">
                                        <div class="input-group">
                                            <input id="unitName" type="text" value="$!parentUnit.name" class="form-control" placeholder="点击右侧按钮选择" disabled/>
			                             		<span class="input-group-btn">
			                             			<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#dialogSelectUnit"><i class="ti-plus"></i> 选择</button>
												</span>
                                        </div>
                                        <input type="hidden" id="unitId" name="unitId" value="$!parentUnit.id" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group" style="height:44px;">
                                    <label for="roleIds" class="col-sm-2 control-label">角色(多选)</label>
                                    <div class="col-sm-8">
                                        <select tabindex="2" id="roleIds" name="roleIds" data-placeholder="<--选择机构后，选择角色" style="width:100%" multiple class="form-control chosen" data-parsley-required="true">
                                            #foreach($!role in $!roleList)
                                            <option value="$!role.id" #if($!roleIds.contains("$!role.code"))selected="selected"#end> #if(!$!role.unitId)[系统]#end$!role.name
                                            #end
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label for="username" class="col-sm-2 control-label">用户名</label>
                                    <div class="col-sm-8">
                                        <input type="text" id="username" value="$!obj.username" tabindex="3" class="form-control" name="u.username" data-parsley-required="true" placeholder="登陆时使用的用户名">
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label for="nickname" class="col-sm-2 control-label">昵称</label>
                                    <div class="col-sm-8">
                                        <input type="text" id="nickname" value="$!obj.profile.nickname" tabindex="4" class="form-control" name="p.nickname" data-parsley-required="true" placeholder="昵称或姓名">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label for="email" class="col-sm-2 control-label">邮箱</label>
                                    <div class="col-sm-8">
                                        <input id="email" type="text" tabindex="7" value="$!obj.profile.email" name="p.email" data-parsley-type="email" class="form-control" placeholder="电子邮箱地址 wizzer@qq.com">
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label for="mobile" class="col-sm-2 control-label">联系方式</label>
                                    <div class="col-sm-8">
                                        <input id="mobile" type="text" tabindex="8" value="$!obj.profile.mobile" name="p.mobile" class="form-control" data-parsley-type="digits" placeholder="固定电话或手机号码">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label for="linkQq" class="col-sm-2 control-label">QQ</label>
                                    <div class="col-sm-8">
                                        <input id="linkQq" type="text" name="p.linkQq" value="$!obj.profile.linkQq" tabindex="10" data-parsley-type="number" class="form-control" placeholder="QQ号码">
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label for="linkWebsite" class="col-sm-2 control-label">主页</label>
                                    <div class="col-sm-8">
                                        <input id="linkWebsite" type="text" name="p.linkWebsite" value="$!obj.profile.linkWebsite" tabindex="10" data-parsley-type="url"  class="form-control" placeholder="http://www.wizzer.cn">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label for="address" class="col-sm-2 control-label">住址</label>
                                    <div class="col-sm-8">
                                        <input id="address" type="text" name="p.address" value="$!obj.profile.address" tabindex="10" class="form-control" placeholder="住址">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label for="locked" class="col-sm-2 control-label">是否禁用</label>
                                    <div class="col-sm-8 switcha">
                                        <div class="mr15">
                                            <input type="checkbox" id="locked" name="u.locked" #if($!obj.locked)checked="checked"#end class="js-switch-blue" >
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3"></div>
                        <div class="col-lg-6">
                            <div class="form-group text-center">
                                <label></label>
                                <div>
                                    <button class="btn btn-primary btn-block btn-lg btn-parsley" data-loading-text="正在提交...">提   交</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </section>
            </div>
        </div>
        <a class="exit-offscreen"></a>
    </section>

</section>
<!-- 选择机构 -->
<div id="dialogSelectUnit" class="modal fade bs-modal-sm" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">选择机构</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-xs-12">
                        <div id="jsTreeUnit" class="demo"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取  消</button>
                <button type="button" class="btn btn-primary" onclick="selectUnit()">确认选择</button>
            </div>
        </div>
    </div>
</div>

#sys_buttom
<script src="${base}/include/plugins/jquery.nestable.js"></script>
<script src="${base}/include/js/toast.js"></script>
<script src="${base}/include/js/treetable.js"></script>
<script src="${base}/include/js/datatables.js"></script>
<script src="${base}/include/js/tree.js"></script>
<script src="${base}/include/plugins/jquery.form.js"></script>
<script src="${base}/include/plugins/parsley.min.js"></script>
#if(!$app_language||$app_language=="zh_CN")
<script src="${base}/include/plugins/parsley.zh_cn.js"></script>
#end
<script language="JavaScript">
    function initTreeView(){
        $("#jsTreeUnit").jstree({
            plugins : [ "wholerow"],
            core : {
                data : {
                    url : function(node){
                        return node.id === "#" ? "${base}/private/sys/user/tree" : "${base}/private/sys/user/tree?pid="+node.id
                    }
                },
                multiple : false
            }
        }).on("dblclick.jstree", function(node){
            selectUnit();
        });
    }
    //选择机构
    function selectUnit(){
        var tree = $.jstree.reference("#jsTreeUnit");
        var node = tree.get_selected(true);
        $("#userAddForm #unitName").val(node[0].text);
        $("#userAddForm input[name='unitId']").val(node[0].id);

        //根据获取的机构，获取角色列表
        jQuery.post("${base}/private/sys/user/role/"+node[0].id,{},function(data){
            var roleSelect = $("#userAddForm select[name='roleIds']");
            if(data.type="success"&&data.data.length > 0){
                var html = "";
                for(var i=0;i<data.data.length;i++){
                    var role = data.data[i];
                    var t="";
                    if(""==role.unitid){
                        t="[系统]";
                    }
                    html += "<option value='"+role.id+"'>"+t+role.name+"</option>";
                }
                roleSelect.html(html);
            }else{
                roleSelect.html("");
                Toast.warning("当前机构无角色，请添加角色后再添加用户!");
            }
            roleSelect.trigger("chosen:updated");
        },"json");
        $("#dialogSelectUnit").modal("hide");
    }
    $(document).ready(function () {
        initTreeView();
        $('#userAddForm').ajaxForm({
            dataType:  'json',
            beforeSubmit:function(arr, form, options){
                if(!$("#unitId").val()){
                    Toast.error("请选择一个机构！");
                    return false;
                }
                var roleIds = $("#userAddForm select[name='roleIds']").val();
                if(!roleIds){
                    Toast.error("至少需要选择一个角色！");
                    return false;
                }
                form.find("button:submit").button("loading");
            },
            success : function(data, statusText, xhr, form) {
                if(data.type == "success"){
                    Toast.success(data.content+"，2秒后返回用户管理首页", function(){
                        window.location.href="${base}/private/sys/user";
                    });
                    setTimeout(function(){
                        window.location.href="${base}/private/sys/user";
                    }, 2000);
                }else{
                    Toast.error(data.content);
                }
                form.find("button:submit").button("reset");
            }
        });
    });

</script>
</body>

</html>
